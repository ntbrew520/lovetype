<!-- web/detail.html まるごとコピペ用 -->
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>LOVE TYPE｜詳細</title>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EE7NY2ZLWX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EE7NY2ZLWX');
</script>
<script src="./config.js"></script>

<style>
:root{
  --p1:#ffc5dd; --p2:#ffb9d4; --cream:#fff7ee;
  --angel-col: clamp(120px, 32vw, 210px);
  --dog-col:   clamp(90px,  22vw, 160px);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:#ffe9f4;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}

.wrap{width:min(520px,94vw);margin:0 auto;padding:20px 0 32px}
.screen{
  position:relative;width:100%;aspect-ratio:9/16;border-radius:28px;overflow:hidden;
  box-shadow:0 8px 24px rgba(0,0,0,.08);background:linear-gradient(180deg,var(--p1),var(--p2))
}
.panel{position:absolute;inset:0;margin:5% 4%;border-radius:42px;background:linear-gradient(180deg,var(--p2),var(--p1));z-index:0}

/* 上：詳細本文（見出し＋箇条書きに整形して表示） */
.card-top{
  position:absolute;left:7%;right:7%;top:6.5%;height:28%;
  background:var(--cream);border-radius:28px;padding:14px 16px;overflow:auto;z-index:1
}
.card-top .sec{margin:6px 0 8px}
.card-top .k{font-weight:900;font-size:14px;margin-bottom:4px;color:#333}
.card-top .v{font-size:13px;line-height:1.8;color:#333;white-space:pre-line;word-break:break-word}
.card-top .v ul{margin:0;padding-left:1.2em}
.card-top .v li{margin:2px 0}

/* 中央：黒縁（空白のまま／将来用）→右のキャラ分スペース確保 */
.bubble{
  position:absolute;top:40%;left:8%;right:calc(8% + var(--angel-col));
  min-height:18%;background:#fff;border:6px solid #111;border-radius:22px;z-index:1
}

/* 下：確信度（犬と被らないよう左側を空ける） */
.card-bottom{
  position:absolute;left:calc(10% + var(--dog-col) * 0.6);right:10%;bottom:6%;
  height:28%;background:var(--cream);border-radius:28px;padding:14px;
  display:grid;place-items:center;text-align:center;z-index:1
}
.meter{width:88%;height:16px;background:#fff;border:3px solid #000;border-radius:999px;overflow:hidden;margin:8px auto 0}
.meter i{display:block;height:100%;width:0;background:#ff8fbf}
.small{font-size:12px;opacity:.75}

/* 画像（前面） */
.da{position:absolute;right:4%;bottom:36%;width:var(--angel-col);pointer-events:none;z-index:2}
.dog{position:absolute;left:4%;bottom:7%;width:var(--dog-col);pointer-events:none;z-index:2}

/* 戻る（より上に、ノッチにも配慮） */
.back{
  position:absolute;left:6%;
  top:calc(2% + env(safe-area-inset-top, 0px));
  background:#fff;border-radius:999px;padding:8px 12px;font-weight:900;
  text-decoration:none;color:#333;border:3px solid #000;z-index:3
}

/* 細い端末の保険 */
@media (max-width:420px){
  .bubble{left:7%;right:calc(7% + var(--angel-col))}
  .card-bottom{left:calc(10% + var(--dog-col) * 0.7)}
}
</style>
</head>
<body>
<main class="wrap">
  <section class="screen">
    <div class="panel"></div>

    <a class="back" href="./index.html">← TOP</a>

    <!-- 上：詳細（自動整形して差し込み） -->
    <div id="detailBody" class="card-top">読み込み中…</div>

    <!-- 中央：黒縁（空白のまま） -->
    <div class="bubble" aria-hidden="true"></div>

    <!-- 下：確信度 -->
    <div class="card-bottom">
      <div><strong>確信度</strong>：<span id="confNum">—%</span></div>
      <div class="meter"><i id="barFill"></i></div>
      <div class="small">※アルゴリズムの目安値</div>
    </div>

    <img class="da"  src="./img/char-angeldevil.PNG" alt="キャラクター">
    <img class="dog" src="./img/char-dog.PNG"        alt="犬">
  </section>
</main>

<script>
const API=(window.API_BASE||'').replace(/\/+$/,'');
const q=new URL(location.href).searchParams; const a=q.get('a'), b=q.get('b');
if(!a||!b){ location.replace('./index.html'); }

/* API */
async function fetchScore(a,b){
  let r=await fetch(API+'/score',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({typeA:a,typeB:b})});
  let j=await r.json();
  if(!r.ok){
    r=await fetch(API+'/score',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({a,b})});
    j=await r.json();
    if(!r.ok) throw new Error(j.detail||'score error');
  }
  return j;
}
function toPercent(x){ if(x==null) return 0; if(typeof x==='number' && x<=1) return Math.round(x*100); return Math.round(+x)||0; }

/* 詳細テキストを 1)【見出し】…形式 2)「アドバイス：」分割 3) そのまま
   の優先順でレンダリングする（改行はCSSのpre-lineで反映） */
function renderDetail(text){
  const root = document.getElementById('detailBody');
  root.innerHTML = '';
  const t = (text||'').trim();
  if(!t){ root.textContent='—'; return; }

  const addSec=(title, body)=>{
    const sec = document.createElement('div'); sec.className='sec';
    const k = document.createElement('div');  k.className='k'; k.textContent = `【${title}】`;
    const v = document.createElement('div');  v.className='v';

    // 複数行なら箇条書き、1行ならそのまま
    const lines = body.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    if(lines.length>1){
      const ul=document.createElement('ul');
      for(const ln of lines){ const li=document.createElement('li'); li.textContent=ln; ul.appendChild(li); }
      v.appendChild(ul);
    }else{
      v.textContent = body || '—';
    }
    sec.appendChild(k); sec.appendChild(v); root.appendChild(sec);
  };

  // 1) 【見出し】… で区切られている場合
  const m = [...t.matchAll(/【([^】]+)】/g)];
  if(m.length){
    for(let i=0;i<m.length;i++){
      const title=m[i][1];
      const from=m[i].index+m[i][0].length;
      const to  =(i+1<m.length)?m[i+1].index:t.length;
      addSec(title, t.slice(from,to).trim());
    }
    return;
  }

  // 2) 「アドバイス：」で分割されている場合
  const parts = t.split('アドバイス：');
  if(parts.length>=2){
    addSec('特徴', parts[0].trim());
    addSec('アドバイス', parts.slice(1).join('アドバイス：').trim());
    return;
  }

  // 3) そのまま1セクション
  addSec('詳細', t);
}

(async()=>{
  try{
    const p=await fetchScore(a,b);
    const detailText = p?.copy?.body || p.detail || '—';
    renderDetail(detailText);

    const c = toPercent(p.confidence ?? p.meta?.confidence);
    document.getElementById('confNum').textContent = c + '%';
    document.getElementById('barFill').style.width = Math.max(0,Math.min(c,100)) + '%';
  }catch(e){
    alert('通信エラー：詳細を取得できませんでした');
  }
})();
</script>
</body>
</html>
